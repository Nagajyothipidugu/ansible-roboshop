- name: configure catalogue component 
  hosts: catalogue 
  become: yes 
  tasks: 
   - name: disable nodejs 
     ansible.builtin.command: dnf module disable nodejs -y 

   - name: enable nodejs-20
     ansible.builtin.command: dnf module enable nodejs:20 -y  

   - name: Install nodejs-20 
     ansible.builtin.dnf: 
      name: nodejs 
      state: present 

   - name: Create roboshop system user 
     ansible.builtin.user: 
       name: roboshop 
       shell: /sbin/nologin 
       system: true 
       home: /app    

   - name: create app directory 
     ansible.builtin.file: 
       path: /app 
       state: directory 

   - name: Download the catalogue code 
     ansible.builtin.get_url: 
       url: https://roboshop-artifacts.s3.amazonaws.com/catalogue-v3.zip 
       dest: /tmp/catalogue.zip 

   # this module thinks file exist on ansible control server, need to extracts on to remote machine
   # remote_src: yes.. means file already exists in catalogue server
   - name: Extract catalogue code 
     ansible.builtin.unarchive: 
       src: /tmp/catalogue.zip 
       dest: /app 
       remote_src: yes

   - name: install dependencies 
     community.general.npm:
      path: /app 

   - name: copy catalogue service system directory 
     ansible.builtin.copy: 
       src: catalogue.service 
       dest: /etc/systemd/system/catalogue.service   

   - name: systemctl daemon reload 
     ansible.builtin.systemd_service:
       daemon_reload: true  

   - name: start and enable catalogue 
     ansible.builtin.service: 
      state: started 
      enabled: yes     
                 
